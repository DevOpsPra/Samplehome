name: Mirror to Private Repo

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  mirror:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the source repo
      - name: Checkout source repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Important to get full history for mirroring

      # Step 2: Configure Git user
      - name: Configure Git
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"

      - name: Debug TARGET_REPO_PAT length
        run: echo "PAT length:${{ secrets.TARGET_REPO_PAT }}" | wc -c
    

      # Step 3: Test access to the destination repo
      - name: Test destination repo access
        run: |
          echo "Checking access to destination repo..."
          git ls-remote https://technolearn-cloud1:${{ secrets.TARGET_REPO_PAT }}@github.com/technolearn-cloud1/item-mirror.git

      # Step 4: Push all branches directly to destination repo
      - name: Push all branches
        run: |
          git push https://technolearn-cloud1:${{ secrets.TARGET_REPO_PAT }}@github.com/technolearn-cloud1/item-mirror.git --all --force

      # Step 5: Push all tags directly to destination repo
      - name: Push all tags
        run: |
          git push https://technolearn-cloud1:${{ secrets.TARGET_REPO_PAT }}@github.com/technolearn-cloud1/item-mirror.git --tags --force

    env:
      # PAT must belong to the owner of the destination repo and have write permissions
      TARGET_REPO_PAT: ${{ secrets.TARGET_REPO_PAT }}
